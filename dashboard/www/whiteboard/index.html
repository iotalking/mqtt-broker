<html>

	<head>
		<meta charset="utf-8" />
		<title>白板</title>
		<script src="../libs/vue.min.js"></script>
		<script src="../libs/mqtt.min.js"></script>
	</head>

	<body style="padding: 0;margin: 0;">
		<div id="app">
			<canvas v-show="client != null" ref="canvas" v-on:mouseDown="canMouseDown" v-on:mouseMove="canMouseMove" v-on:mouseUp="canMouseUp" v-on:touchstart="canTouchStart" v-on:touchmove="canTouchMove" v-on:touchend="canTouchEnd"  class="canvas">
			</canvas>
			<img v-show="client != null" v-on:click="disconnect" style="border-radius: 100%;width: 32px;position: absolute;right: 0;" src="img/exit.png"></img>
			<div v-show="client != null" style="text-align: center;">
				<span v-text=`房间:${boardName}`></span>
			</div>

		</div>
		<style type="text/css">
			.canvas {
				position: absolute;
				width: 100%;
				height: 100%;
				overflow: hidden;
			}
		</style>
	</body>
	<script type="text/javascript">
		var app = new Vue({
			el: '#app',
			data: {
				boardShow: false,
				boardName: "hello",
				client: null,
				x:0,
				y:0,
			},
			mounted: function() {
				var canvas = this.$refs.canvas;
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
				//如果没有hash.name，则从cookie中读取name,并个性hash
				var reg = /name=(\w+)/;
				if(location.hash == ""){
					//owner身份进来
					this.isOwner = true;
					m = document.cookie.match(reg)
				}else{
					m = location.hash.match(reg)
				}
				if(m){
					this.boardName = m[1];
					location.hash = `name=${this.boardName}`;
				}
				this.clearBoard();
				this.connect();
			},
			mouseDown: false,

			methods: {
				getDataTopic: function() {
					return `deamo/board/${this.boardName}/data`;
				},
				getNewUserTopic:function(){
					return `deamo/board/${this.boardName}/newuser`;	
				},
				getImageTopic:function(clientId){
					return `deamo/board/${this.boardName}/image/${clientId}`;	
				},
				clientId:function(){
					if(!this.client){
						return "";
					}
					return this.client.options.clientId;
				},
				connect: function() {
					if(this.client) {
						return;
					}
					var hostname = location.hostname;
					var client = mqtt.connect('ws://' + hostname + ':8083/mqtt');
					var comp = this;
					this.client = client;
					client = null;
					this.client.on('connect', function() {
						//订阅笔迹数据
						comp.client.subscribe(comp.getDataTopic());
						//订阅白板历史图像
						comp.client.subscribe(comp.getImageTopic(comp.clientId()));
						//订阅新用户进来
						if(comp.isOwner == true){
							comp.client.subscribe(comp.getNewUserTopic());
						}else{
							//从owner处获取历史数据
							comp.client.publish(comp.getNewUserTopic(),comp.clientId());
						}
						
						
						comp.client.on('message', function(topic, payload) {
							if(topic == comp.getDataTopic()) {
								var data = JSON.parse(payload);
								switch(data.mouse.action) {
									case "down":
										comp.drawDown(data.mouse.x, data.mouse.y);
										break;
									case "move":
										comp.drawMove(data.mouse.x, data.mouse.y);
										break;
									case "up":
										comp.drawUp(data.mouse.x, data.mouse.y);
								}
							}else if(topic == comp.getImageTopic(comp.clientId())){
								console.log(topic);
								comp.drawImage(payload.toString());
							}else if(topic == comp.getNewUserTopic()){
								console.log(topic);
								comp.publishImage(payload.toString());
							}
						});
					});

				},
				drawImage:function(dataUrl){
					if(!this.client) {
						return;
					}
					var img = document.createElement('img');
					var ctx = this.ctx();
					img.onload = function(){
						ctx.drawImage(img,0,0);
						img = null;
						ctx = null;
					}
					img.src = dataUrl;
					
					
				},
				disconnect: function() {
					if(!this.client) {
						return;
					}
					if(this.client.disconnecting) {
						return;
					}
					this.client.end();
					this.client = null;
				},
				publish: function(data) {
					if(this.client && this.client.connected) {
						this.client.publish(this.getDataTopic(), JSON.stringify(data));
					}
				},
				publishImage:function(clientId){
					if(this.client && this.client.connected) {
						var canvas = this.$refs.canvas;
						this.client.publish(this.getImageTopic(clientId),canvas.toDataURL());
					}
				},
				ctx: function() {
					return this.$refs.canvas.getContext('2d');
				},
				clearBoard: function() {
					var ctx = this.ctx();
					var canvas = this.$refs.canvas;
					ctx.clearRect(0, 0, canvas.width, canvas.height);
				},
				
				drawDown: function(x, y) {
					var ctx = this.ctx();
					ctx.beginPath();
					ctx.moveTo(x, y);
				},
				drawMove: function(x, y) {
					var ctx = this.ctx();
					ctx.lineTo(x, y);
					ctx.stroke();
				},
				drawUp: function(x, y) {
					var ctx = this.ctx();

				},
				canTouchStart:function(e){
					this.canMouseDown({
						x:e.touches[0].clientX,
						y:e.touches[0].clientY,
					});
				},
				canTouchMove:function(e){
					this.canMouseMove({
						x:e.touches[0].clientX,
						y:e.touches[0].clientY,
					});
				},
				canTouchEnd:function(e){
					this.canMouseUp({
						x:this.x,
						y:this.y,
					});
				},
				canMouseDown: function(e) {
					this.mouseDown = true;
					if(!this.client) {
						return;
					}
					var canvas = this.$refs.canvas;
					var x = e.x,
						y = e.y;
					x -= canvas.offsetLeft;
					y -= canvas.offsetTop;

					this.publish({
						mouse: {
							action: 'down',
							x: x,
							y: y,
						}

					});
					this.x = x;
					this.y = y;
				},

				canMouseMove: function(e) {
					if(!this.client || !this.mouseDown) {
						return;
					}
					var canvas = this.$refs.canvas;
					var x = e.x,
						y = e.y;
					x -= canvas.offsetLeft;
					y -= canvas.offsetTop;
					this.publish({
						mouse: {
							action: 'move',
							x: x,
							y: y,
						}
					});
					this.x = x;
					this.y = y;
				},
				canMouseUp: function(e) {
					this.mouseDown = false;
					if(!this.client) {
						return;
					}
					var canvas = this.$refs.canvas;
					var x = e.x,
						y = e.y;
					x -= canvas.offsetLeft;
					y -= canvas.offsetTop;
					this.publish({
						mouse: {
							action: 'up',
							x: e.x,
							y: e.y,
						}
					});
				},
			}
		})
	</script>

</html>